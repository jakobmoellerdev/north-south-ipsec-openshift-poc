# POC for IPSec Performance Measurements on OpenShift SNO Clusters

## Node Setup

Create an SNO cluster with version 4.14+ and prepare any Node with iperf installed that is running on the same
NIC as the SNO cluster node. The iperf node will be referred to as the RHEL node because we used RHEL in this example.

## Setup and Machine Configuration Adjustments

Generate fresh certificates with the following command:

```bash
sh ipsec-new-cert-gen.sh
```

Generate machine configuration objects for ipsec nodes with the following command:

```bash
sh manifest-ipsec-butane.sh
```

After this apply all the resources to the SNO cluster with the following command:

```bash
sh apply.sh
```

This will apply real-time kernel configuration as well as ipsec configuration to the nodes.

After a node reboot, we will apply the certificates to the nodes. Below scripts assume certificates in the working directory
named `north.crt`, `north.p12`, `south.crt`, `south.p12` as well as a ca in `/etc/pki/certs/ca.pem. These are the certificates generated by the `ipsec-new-cert-gen.sh` script.

For the SNO cluster:
```bash
certutil -A -i /etc/pki/certs/ca.pem -n "ipsec-test-ca" -t "CT,," -d sql:/var/lib/ipsec/nss
# this assumes the current node is south, the other node is north
certutil -A -i north.crt -n "north" -t "P,," -d sql:/var/lib/ipsec/nss
ipsec import ./south.p12 --nssdir /var/lib/ipsec/nss
```

For the other node:
```bash
[ ! -f /etc/ipsec.d/cert9.db ] && ipsec initnss --nssdir /etc/ipsec.d || echo
certutil -A -i /etc/pki/certs/ca.pem -n "ipsec-test-ca" -t "CT,," -d sql:/var/lib/ipsec/nss
# this assumes the current node is north, the other node is south
certutil -A -i south.crt -n "south" -t "P,," -d sql:/var/lib/ipsec/nss
ipsec import ./north.p12 --nssdir /var/lib/ipsec/nss
```

Next one needs to read out the IPs of the nodes and update the ipsec configuration in `/etc/ipsec.d/host-to-host-cert.conf` accordingly, an example is located at `ipsec.conf`.
After this is done, we can simply restart the ipsec service on both nodes with `systemctl restart ipsec`.
Now we can check the status of the ipsec connection with `ipsec` on both nodes by `ping -n -c 4 OTHER_NODE` and controlling the ESP packets with `ipsec trafficstatus`.
After we have the ESP packets verified, we now need to issue load test commands to the SNO cluster.

# Load Test
First, on the RHEL Node launch the iperf server with the following command:

```bash
iperf3 -s
```

On the SNO cluster, we will also need to run https://github.com/Avielyo10/prom to scrape the Process ID
metrics for the iperf process. prom should be setup in advance so that the metrics are scraped accordingly.

Make sure that the firewall is disabled and that it is pingable by the SNO node.

Now on the SNO cluster, we can launch the iperf client with the following command:
```bash
podman run -it --rm networkstatic/iperf3 --pid=host -c $OTHER_NODE_IPSEC_IP --json
```

This will create an iperf test on the SNO cluster with a native PID that can be queried by prometheus CPU metrics.
Alternatively one can run this command as a privileged pod with hostPID on the SNO cluster.
Either way, the given PID should now be monitored by system_time to observe the time spent in the CPU for the encryption.
If run via container, the PID can be discovered via `podman inspect --format '{{ .PidFile }}' $CONTAINER_ID`

The command will output a json file that can be parsed for network throughput information.
Additionally, prometheus will now have scraped cpu metrics. Now we simply need to look at the CPU metrics for the given PID.

